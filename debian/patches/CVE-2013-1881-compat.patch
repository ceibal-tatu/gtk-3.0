Description: fix regression from librsvg CVE-2013-1881 security fix
Origin: backport, https://git.gnome.org/browse/gtk+/commit/?id=7b4f82ccc6c180b809cd3b7b6582394ce741a14e
Origin: backport, https://git.gnome.org/browse/gtk+/commit/?id=3d602f5b0a67a7b515dc5add504e02e486aad70c
Bug-Debian: http://bugs.debian.org/cgi-bin/bugreport.cgi?bug=724741

Index: gtk+3.0-3.4.2/gtk/gtkicontheme.c
===================================================================
--- gtk+3.0-3.4.2.orig/gtk/gtkicontheme.c	2014-03-14 10:10:38.303084725 -0400
+++ gtk+3.0-3.4.2/gtk/gtkicontheme.c	2014-03-14 10:11:31.859086159 -0400
@@ -3153,6 +3153,8 @@
   GdkPixbuf *pixbuf;
   gchar *data;
   gchar *success, *warning, *err;
+  gchar *file_data, *escaped_file_data;
+  gsize file_len;
 
   /* css_fg can't possibly have failed, otherwise
    * that would mean we have a broken style */
@@ -3176,6 +3178,11 @@
       err = gdk_color_to_css (&error_default_color);
     }
 
+  if (!g_file_get_contents (icon_info->filename, &file_data, &file_len, NULL))
+    return NULL;
+
+  escaped_file_data = g_markup_escape_text (file_data, file_len);
+  g_free (file_data);
 
   data = g_strconcat ("<?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"no\"?>\n"
                       "<svg version=\"1.1\"\n"
@@ -3197,9 +3204,10 @@
                       "      fill: ", css_success ? css_success : success," !important;\n"
                       "    }\n"
                       "  </style>\n"
-                      "  <xi:include href=\"", icon_info->filename, "\"/>\n"
+                      " <xi:include href=\"data:text/xml,", escaped_file_data, "\"/>\n"
                       "</svg>",
                       NULL);
+  g_free (escaped_file_data);
   g_free (warning);
   g_free (err);
   g_free (success);
